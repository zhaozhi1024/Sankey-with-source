// http://git.sy/pecker/sankey-multilevel v0.0.2 Copyright 2022
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3"),require("lodash"),require("sankey-with-source")):"function"==typeof define&&define.amd?define(["exports","d3","lodash","sankey-with-source"],e):e((t=t||self).sankeyMultilevel=t.sankeyMultilevel||{},t.d3,t._,t.Sankey)}(this,function(t,e,n,i){"use strict";function o(t){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}var r=function(){function t(){this._curvature=.5}return t.prototype.columns=function(t){var e=this;return this._columns=t,this._nodes=[],this._columns.forEach(function(t){t.forEach(function(t){e._nodes.push(t)})}),this.columnCount=this._columns.length,this.columnMap=new Map,this._columns.forEach(function(t,n){e.columnMap.set(n,t.map(function(t){return t.id}))}),this},t.prototype.getNodes=function(){return this._nodes},t.prototype.links=function(t){return this._links=t,this._linksGroupIndexArrary=this._links.map(function(t){return t.linkGroupIndex}),this._linksGroupIndexArrary.sort(function(t,e){return t-e}),this},t.prototype.getLinks=function(){return this._links},t.prototype.nodeWidth=function(t){return this._nodeWidth=t,this},t.prototype.getNodeWidth=function(){return this._nodeWidth},t.prototype.nodePadding=function(t){return this._nodePadding=t,this},t.prototype.getNodePadding=function(){return this._nodePadding},t.prototype.size=function(t){return this._size=t,this},t.prototype.getSize=function(){return this._size},t.prototype.layout=function(t){return this.computeNodeLinks(),this.computeNodeValues(),this.computeNodeBreadths(),this.computeNodeDepths(t),this.computeLinkDepths(),this},t.prototype.curvature=function(t){return this._curvature=t,this},t.prototype.link=function(){var t=this._curvature,n=this;return function(i){var o,r,a,l,s,u,h,c;return i.linkGroupIndex<n.columnCount?(o=i.source.x+i.source.dx,r=i.target.x):(o=i.source.x,r=i.target.x+i.source.dx),l=(a=e.interpolateNumber(o,r))(t),s=a(1-t),"M"+o+","+(u=i.source.y+i.sy)+" C"+l+","+u+" "+s+","+(h=i.target.y+i.ty)+" "+r+","+h+"\n            L"+r+","+(h+(c=i.dy<3&&0!==i.dy?3:i.dy))+"\n            C"+s+","+(h+c)+" "+l+","+(u+c)+" "+o+","+(u+c)+"\n            L"+o+","+u+"\n            "}},t.prototype.find=function(t,e){var n=t.get(e);if(!n)throw new Error("missing: "+e);return n},t.prototype.computeNodeLinks=function(){var t=this;this._nodes.forEach(function(t,e){t.sourceLinks=[],t.targetLinks=[]});var n=e.map(this._nodes,function(t){return t.id});this._links.forEach(function(e,i){var r=e.source,a=e.target;"object"!==o(r)&&(r=e.source=t.find(n,r)),"object"!==o(a)&&(a=e.target=t.find(n,a)),r.sourceLinks.push(e),a.targetLinks.push(e)})},t.prototype.computeNodeValues=function(){this._nodes.forEach(function(t){t.value=Math.max(e.sum(t.sourceLinks.filter(function(t){return 0===t.linkGroupIndex}),function(t){return t.value}),e.sum(t.targetLinks.filter(function(t){return 0===t.linkGroupIndex}),function(t){return t.value}))})},t.prototype.computeNodeBreadths=function(){for(var t=this,n=e.map(this._nodes,function(t){return t.id}),i=function(e){o.columnMap.get(e).forEach(function(i){var o=t.find(n,i);o.dx=t._nodeWidth,o.x=e*(t._size[0]-t._nodeWidth)/(t.columnCount-1)})},o=this,r=0;r<this.columnCount;r++)i(r)},t.prototype.computeNodeDepths=function(t){this.initializeNodeDepth(this._columns)},t.prototype.initializeNodeDepth=function(t){var n=this,i=e.min(t,function(t){return(n._size[1]-(t.length-1)*n._nodePadding)/e.sum(t,function(t){return t.value})});i=e.min(t,function(t,o){return(n._size[1]-(t.length-1)*n._nodePadding)/(e.sum(t,function(t){return t.value})+15*t.length/i)}),t.forEach(function(t){t.forEach(function(t,e){t.value+=11/i,t.dy=t.value*i})}),this._links.forEach(function(t){t.dy=t.value*i}),t.forEach(function(t){var o=e.sum(t,function(t){return t.dy}),r=(n._size[1]-o)/(t.length-1),a=0;t.forEach(function(t,e){t.y=a,t.dy=t.value*i,a=a+t.dy+r})})},t.prototype.resolveCollisions=function(t){var e=this;t.forEach(function(t){var n,i,o,r=0,a=t.length;for(t.sort(function(t,e){return t.y-e.y}),o=0;o<a;++o)(i=r-(n=t[o]).y)>0&&(n.y+=i),r=n.y+n.dy+e._nodePadding;if((i=r-e._nodePadding-e._size[1])>0)for(r=n.y-=i,o=a-2;o>=0;--o)(i=(n=t[o]).y+n.dy+e._nodePadding-r)>0&&(n.y-=i),r=n.y})},t.prototype.relaxRightToLeft=function(t,n){var i=this,o=this;function r(t){return o.center(t.target)*t.value}t.slice().reverse().forEach(function(t){t.forEach(function(t){if(t.sourceLinks.length){var o=e.sum(t.sourceLinks.filter(function(t){return 0===t.linkGroupIndex}),function(t){return t.value});if(o>0){var a=e.sum(t.sourceLinks.filter(function(t){return 0===t.linkGroupIndex}),r)/o;t.y+=(a-i.center(t))*n}0===o&&console.info(t.sourceLinks)}})})},t.prototype.center=function(t){return t.y+t.dy/2},t.prototype.relaxLeftToRight=function(t,n){var i=this,o=this;function r(t){return o.center(t.source)*t.value}t.forEach(function(t,o){t.forEach(function(t){if(t.targetLinks.length){var o=e.sum(t.targetLinks.filter(function(t){return 0===t.linkGroupIndex}),function(t){return t.value});if(o>0){var a=e.sum(t.targetLinks.filter(function(t){return 0===t.linkGroupIndex}),r)/o;t.y+=(a-i.center(t))*n}}})})},t.prototype.computeLinkDepths=function(){var t=this;this._nodes.forEach(function(e){for(var n=function(t){var n=0,i=0;e.sourceLinks.filter(function(e){return e.linkGroupIndex===t}).forEach(function(t){t.sy=n,n+=t.dy}),e.targetLinks.filter(function(e){return e.linkGroupIndex===t}).forEach(function(t){t.ty=i,i+=t.dy})},i=0;i<=t.columnCount-1;i++)n(i);var o=function(t){var n=0,i=0;e.sourceLinks.filter(function(e){return e.linkGroupIndex===t}).forEach(function(t){t.sy=n,n+=t.dy}),e.targetLinks.filter(function(e){return e.linkGroupIndex===t}).forEach(function(t){t.ty=i,i+=t.dy})};for(i=t.columnCount;i<=t.columnCount+t.columnCount-1;i++)o(i)})},t}(),a=function(){function t(t){var e=this;this.chain=[],this.otherLinks=[],this.columnCount=0,this.linkGroupIndexArray=[],this.jumpLevelLinks=[];var i=[["#b79afd","#e87052","#e6c751","#95f5bc"],["#b0d212","#2d40b7","#2f62d5","#3073e9","#e25417","#f27c1d","#ec9620","#7540ee","#DA70D6","#DC143C","#FF00FF","#9932CC"],["#5e2243","#b12572","#9013fe","#cb5f9a","#f64da9","#ffc800","#f8e71c"],["#25265d","#373844","#787993","#2dc76d"],["#404048","#2dc76d","#9b9b9b"]];this.data=t,this.columnMap=new Map,this.data.columns.forEach(function(t,n){t.forEach(function(t,e){t.color&&0!==t.color.length||(t.color=i[n][e])}),e.data.columns[n]=t.filter(function(t){return t.value>0})}),this.data.columns=n.dropRightWhile(this.data.columns,function(t){return 0===t.length}),this.data.columns.forEach(function(t,n){e.columnMap.set(n,e.data.columns[n].map(function(t,e){return t.id}))}),this.columnCount=this.data.columns.length}return t.prototype.initLinkData=function(){this.untilLastCol(0,0,this.data.columns.length-1,!1),this.data.links=[],this.data.links=this.otherLinks,this.data.links.forEach(function(t){t.value=10}),this.otherLinks=[]},t.prototype.parseData=function(){for(var t=this.data.columns.length,e=0;e<this.data.links.length;e++)this.data.links[e].linkGroupIndex=0;this.getJumpLevelLinks();for(e=0;e<t-1;e++){if(0===e)for(var n=t-2;n>0;n--)e<n&&this.untilLastCol(e,e,n,!1);else for(n=t-1;n>0;n--)e<n&&this.untilLastCol(e,e,n,!1);this.linkGroupIndexArray.push(e)}this.chain=[];for(e=t-1;e>=0;e--){for(n=0;n<t-1;n++)e>n&&this.untilLastCol(e+t,e,n,!0);this.linkGroupIndexArray.push(e+t)}this.data.links=this.data.links.concat(this.otherLinks),this.removeDataValueIsZero(),this.handleJumpLevelLinks(),this.mergeScatteredData()},t.prototype.reomveItemsFromArray=function(t,e){e.forEach(function(e){var n=t.indexOf(e);n>-1&&t.splice(n,1)})},t.prototype.removeDataValueIsZero=function(){var t=this;n.clone(this.data.links).forEach(function(e){0===e.value&&t.reomveItemsFromArray(t.data.links,[e])})},t.prototype.mergeScatteredData=function(){var t=this;this.linkGroupIndexArray.sort(function(t,e){return t-e}),this.linkGroupIndexArray.forEach(function(n){n<t.columnCount?t.columnMap.get(n).forEach(function(i){for(var o=function(o){n+o+1<=t.columnCount-1&&t.columnMap.get(n+o).forEach(function(r){for(var a=1;a<=t.columnCount-1-n-o;a++)t.columnMap.get(n+o+a).forEach(function(o){var a=t.data.links.filter(function(t){return t.linkGroupIndex===n&&t.sourceChain[0]===i&&t.source===r&&t.target===o});if(a.length>1){t.reomveItemsFromArray(t.data.links,a);var l=[];a.forEach(function(t){t.inpatIds.forEach(function(t){l.push(t)})});var s={source:r,target:o,sourceChain:[i,r,o],linkGroupIndex:n,value:e.sum(a,function(t){return t.value}),inpatIds:l};t.data.links.push(s)}})})},r=0;r<t.columnCount;r++)o(r)}):t.columnMap.get(n-t.columnCount).forEach(function(i){for(var o=function(o){n-t.columnCount-o-1>=0&&t.columnMap.get(n-t.columnCount-o).forEach(function(r){for(var a=1;a<=n-t.columnCount-o;a++)t.columnMap.get(n-t.columnCount-o-a).forEach(function(o){var a=t.data.links.filter(function(t){return t.linkGroupIndex===n&&t.sourceChain[0]===i&&t.source===r&&t.target===o});if(a.length>1){t.reomveItemsFromArray(t.data.links,a);var l=[];a.forEach(function(t){t.inpatIds.forEach(function(t){l.push(t)})});var s={source:r,target:o,sourceChain:[i,r,o],linkGroupIndex:n,value:e.sum(a,function(t){return t.value}),inpatIds:l};t.data.links.push(s)}})})},r=0;r<t.columnCount;r++)o(r)})})},t.prototype.getColIndexFromId=function(t){for(var e,n=0;n<this.columnMap.size;n++)if(this.columnMap.get(n).indexOf(t)>-1){e=n;break}return e},t.prototype.getJumpLevelLinks=function(){var t=this,e=[],n=this.data.links.filter(function(n){for(var i=!1,o=0;o<n.sourceChain.length;o++){var r;if(r=t.getColIndexFromId(n.sourceChain[o]),t.getColIndexFromId(n.sourceChain[o+1])-r>1){i=!0,e.push([n.sourceChain[o],n.sourceChain[o+1]]);break}}return i});this.reomveItemsFromArray(this.data.links,n),this.jumpLevelLinks=n},t.prototype.handleJumpLevelLinks=function(){var t=this,e=[];this.jumpLevelLinks.forEach(function(n){for(var i=0;i<n.sourceChain.length-1;i++)for(var o=i;o<=n.sourceChain.length-2;o++){var r=t.getColIndexFromId(n.sourceChain[i]),a={source:l=n.sourceChain[o],target:s=n.sourceChain[o+1],sourceChain:o===i?[l,s]:[n.sourceChain[i],l,s],linkGroupIndex:r,value:n.value,inpatIds:n.inpatIds};e.push(a)}for(i=n.sourceChain.length-1;i>0;i--)for(o=i;o>=1;o--){var l,s;r=t.getColIndexFromId(n.sourceChain[i]),a={source:l=n.sourceChain[o],target:s=n.sourceChain[o-1],sourceChain:o===i?[l,s]:[n.sourceChain[i],l,s],linkGroupIndex:r+t.columnCount,value:n.value,inpatIds:n.inpatIds};e.push(a)}}),e.forEach(function(e){t.data.links.push(e)})},t.prototype.untilLastCol=function(t,i,o,r){if(r)if(i>=o)for(var a=0;a<this.columnMap.get(i).length;a++){for(;this.chain.length>t-this.columnMap.size-i;)this.chain.pop();this.chain.push(this.columnMap.get(i)[a]),this.untilLastCol(t,i-1,o,r)}else{var l={source:"",sourceChain:[],target:"",value:0,linkGroupIndex:t,inpatIds:[]};this.chain.forEach(function(t){l.sourceChain.push(t)}),l.source=l.sourceChain[l.sourceChain.length-2],l.target=l.sourceChain[l.sourceChain.length-1];var s=this.data.links.filter(function(t){for(var e=!0,n=0;n<l.sourceChain.length;n++)if(-1===t.sourceChain.indexOf(l.sourceChain[n])){e=!1;break}return(!e||t.sourceChain.length!==l.sourceChain.length||t.sourceChain[0]!==l.sourceChain[0])&&e});l.value=e.sum(s,function(t){return t.value}),s.forEach(function(t){t.inpatIds.forEach(function(t){l.inpatIds.push(t)})}),this.otherLinks.push(n.clone(l))}else if(i<=o)for(a=0;a<this.columnMap.get(i).length;a++){for(;this.chain.length>i-t;)this.chain.pop();this.chain.push(this.columnMap.get(i)[a]),this.untilLastCol(t,i+1,o,r)}else{var u={sourceChain:[],source:"",target:"",value:0,linkGroupIndex:t,inpatIds:[]};this.chain.forEach(function(t){u.sourceChain.push(t)}),u.source=u.sourceChain[u.sourceChain.length-2],u.target=u.sourceChain[u.sourceChain.length-1];s=this.data.links.filter(function(t){for(var e=!0,n=0;n<u.sourceChain.length;n++)if(-1===t.sourceChain.indexOf(u.sourceChain[n])){e=!1;break}return(!e||t.sourceChain.length!==u.sourceChain.length||t.sourceChain[0]!==u.sourceChain[0])&&e});u.value=e.sum(s,function(t){return t.value}),s.forEach(function(t){t.inpatIds.forEach(function(t){u.inpatIds.push(t)})}),this.otherLinks.push(n.clone(u))}},t.prototype.test=function(t,e){return e.forEach(function(e){t.source===e[0]&&t.target===e[1]&&!0,t.source===e[1]&&t.target===e[1]&&!0}),!0},t.prototype.arrayIsEqual=function(t,e){for(var n=!0,i=0;i<t.length;i++)if(-1===e.indexOf(t[i])){n=!1;break}return n=!(!n||e.length!==t.length||e[0]!==t[0])},t}(),l=function(){function t(t){this.linkPathPane=t,this.margin={top:0,right:10,bottom:0,left:0},this.nodeAddWidth=10,this.nodeAddHeight=15,this.createTooltipEle()}return t.prototype.createTooltipEle=function(){this.linkPathTooltip=document.createElement("div"),this.linkPathTooltip.setAttribute("style","\n        position: absolute;\n        background: black;\n        opacity: 0.9;\n        top: 0;\n        left: 0;\n        width: auto;\n        white-space: nowrap;\n        transition-duration: 120;\n        border-radius: 5px;\n        z-index: 9999;\n        padding: 5px 10px;\n        display: none;");var t=window.getComputedStyle(this.linkPathPane).position;"relative"!=t&&"absolute"!=t&&this.linkPathPane.style.setProperty("position","relative"),this.linkPathPane.appendChild(this.linkPathTooltip)},t.prototype.clearLinkPathInfo=function(){this.data={levelSumCount:1,linkInfo:[]},this.clean()},t.prototype.draw=function(t){this.data=t,this.getSize(),this.clean(),this.drawSvg(),this.drawMarker(),this.drawNodeLabel(),this.drawLine(),this.drawLinkInfo(),this.bindEvent()},t.prototype.resize=function(){this.data.linkInfo.length>0&&(this.getSize(),this.clean(),this.drawSvg(),this.drawMarker(),this.drawNodeLabel(),this.drawLine(),this.drawLinkInfo(),this.bindEvent())},t.prototype.getSize=function(){var t=this.linkPathPane.getClientRects();t&&t[0]&&(this.width=t[0].width-this.margin.left-this.margin.right,this.height=t[0].height-this.margin.top-this.margin.bottom,this.colmInterval=this.width/(this.data.levelSumCount-1))},t.prototype.drawSvg=function(){this.svg=e.select(this.linkPathPane).append("svg").attr("width",this.width).attr("height",this.height).append("g").attr("transform","translate("+this.margin.left+","+this.margin.top+")")},t.prototype.drawMarker=function(){this.svg.append("defs").selectAll(".markerArrow").data(this.data.linkInfo).enter().append("marker").attr("id",function(t){return"markerArrow"+t.nodeId}).attr("markerWidth",5).attr("markerHeight",5).attr("markerUnits","strokeWidth").attr("viewBox","0 0 11 11").attr("refX",11).attr("refY",6).attr("orient","auto").append("path").attr("d","M2,2 L2,11 L10,6 L2,2").attr("fill",function(t){return t.color})},t.prototype.drawNodeLabel=function(){var t=this;this.svg.selectAll(".nodeLabelG").data(this.data.linkInfo).enter().append("g").attr("class","nodeLabelG").attr("transform",function(e){return"translate("+t.colmInterval*e.levelIndex+",0)"}).append("rect").attr("id",function(t){return"nodeLabelRect"+t.levelIndex}).attr("x",0).attr("y",0).attr("width",100).attr("height",100).attr("stroke",function(t){return t.color}).attr("stroke-width",1).attr("fill",function(t){return t.color}),this.svg.selectAll(".nodeLabelG").append("text").attr("x",0).attr("y",0).attr("fill","white").style("font-size",12).style("line-height",12).style("font-family","PingFangSC").text(function(t,e){return""}).append("tspan").attr("id",function(t){return"nodeLabelText"+t.levelIndex}).attr("x",5).attr("y",0).attr("dy","1.7em").attr("text-anchor",function(t){return"start"}).text(function(t){return t.nodeLabel}),this.svg.selectAll(".nodeLabelG").attr("transform",function(e){return 0===e.levelIndex?"translate(0,0)":e.levelIndex===t.data.levelSumCount-1?"translate("+(t.colmInterval*e.levelIndex-(t.getDimensions("nodeLabelText"+e.levelIndex).w+t.nodeAddWidth))+",0)":"translate("+(t.colmInterval*e.levelIndex-.5*(t.getDimensions("nodeLabelText"+e.levelIndex).w+t.nodeAddWidth))+",0)"}).selectAll("rect").attr("width",function(e){return t.getDimensions("nodeLabelText"+e.levelIndex).w+t.nodeAddWidth}).attr("height",function(e){return t.getDimensions("nodeLabelText"+e.levelIndex).h+t.nodeAddHeight})},t.prototype.drawLine=function(){var t=this;this.svg.selectAll(".xlineG").data(this.data.linkInfo).enter().filter(function(e,n){return n<t.data.linkInfo.length-1}).append("g").attr("class","xlineG").attr("transform",function(e){return"translate("+(e.direction>0?0===e.levelIndex?t.getDimensions("nodeLabelRect"+e.levelIndex).w:e.levelIndex===t.data.levelSumCount-1?t.colmInterval*e.levelIndex-t.getDimensions("nodeLabelRect"+e.levelIndex).w:t.colmInterval*e.levelIndex+.5*t.getDimensions("nodeLabelRect"+e.levelIndex).w:t.colmInterval*e.levelIndex-t.getDimensions("nodeLabelRect"+e.levelIndex).w/(e.levelIndex===t.data.levelSumCount-1?1:2))+",0)"}).append("line").attr("x1",0).attr("y1",15).attr("x2",function(e,n){return e.direction>0?t.colmInterval*Math.abs(e.levelIndex-t.data.linkInfo[n+1].levelIndex)-t.getDimensions("nodeLabelRect"+e.levelIndex).w/(0===e.levelIndex?1:2)-t.getDimensions("nodeLabelRect"+t.data.linkInfo[n+1].levelIndex).w/(t.data.linkInfo[n+1].levelIndex===t.data.levelSumCount-1?1:2):-(t.colmInterval*Math.abs(e.levelIndex-t.data.linkInfo[n+1].levelIndex)-t.getDimensions("nodeLabelRect"+e.levelIndex).w/(e.levelIndex===t.data.levelSumCount-1?1:2)-t.getDimensions("nodeLabelRect"+t.data.linkInfo[n+1].levelIndex).w/(0===t.data.linkInfo[n+1].levelIndex?1:2))}).attr("y2",15).attr("stroke",function(t){return t.color}).attr("stroke-width",2).attr("marker-end",function(t){return"url(#markerArrow"+t.nodeId+")"})},t.prototype.drawLinkInfo=function(){var t=this;this.svg.selectAll(".xlineG").append("text").attr("x",function(e,n){return.5*(e.direction>0?t.colmInterval*Math.abs(e.levelIndex-t.data.linkInfo[n+1].levelIndex)-t.getDimensions("nodeLabelRect"+e.levelIndex).w/(0===e.levelIndex?1:2)-t.getDimensions("nodeLabelRect"+t.data.linkInfo[n+1].levelIndex).w/(t.data.linkInfo[n+1].levelIndex===t.data.levelSumCount-1?1:2):-(t.colmInterval*Math.abs(e.levelIndex-t.data.linkInfo[n+1].levelIndex)-t.getDimensions("nodeLabelRect"+e.levelIndex).w/(e.levelIndex===t.data.levelSumCount-1?1:2)-t.getDimensions("nodeLabelRect"+t.data.linkInfo[n+1].levelIndex).w/(0===t.data.linkInfo[n+1].levelIndex?1:2)))}).attr("y",10).attr("text-anchor","middle").style("font-size",12).attr("fill",function(t){return t.color}).attr("font-family","PingFangSC").text(function(t){return t.linkValue})},t.prototype.showTooltip=function(t){var e=document.createElement("span");for(e.setAttribute("style","\n            line-height: 20px;\n            font-size: 12px;\n            color: white;\n            font-family: PingFangSC;\n        "),t.forEach(function(t){e.innerHTML=t});this.linkPathTooltip.firstChild;)this.linkPathTooltip.removeChild(this.linkPathTooltip.firstChild);this.linkPathTooltip.style.setProperty("display","block"),this.linkPathTooltip.appendChild(e)},t.prototype.moveTooltip=function(t,e){this.linkPathTooltip.style.setProperty("top",e+"px"),this.linkPathTooltip.style.setProperty("left",t+"px")},t.prototype.hiddenTooltip=function(){for(;this.linkPathTooltip.firstChild;)this.linkPathTooltip.removeChild(this.linkPathTooltip.firstChild);this.linkPathTooltip.style.setProperty("display","none")},t.prototype.unbindEvent=function(){this.svg&&this.svg.selectAll(".restValueText").on("mouseover",null),this.svg&&this.svg.selectAll(".restValueText").on("mousemove",null),this.svg&&this.svg.selectAll(".restValueText").on("mouseout",null)},t.prototype.bindEvent=function(){var t=this;this.svg.selectAll(".restValueText").on("mouseover",function(e){t.showTooltip([e.nodeLabel+"的人里，未做过（"+e.nextNodeLabel+"）的人"])}),this.svg.selectAll(".restValueText").on("mousemove",function(n){var i=e.mouse(t.svg.node()),o=i[0]+10,r=i[1]+10,a=Number(window.getComputedStyle(t.linkPathTooltip).width.replace("px","")),l=Number(window.getComputedStyle(t.linkPathTooltip).height.replace("px",""));o+a>t.width&&(o=o-a-20),t.moveTooltip(o,r-l)}),this.svg.selectAll(".restValueText").on("mouseout",function(e){t.hiddenTooltip()})},t.prototype.getDimensions=function(t){var e=document.getElementById(t),n=0,i=0;if(e){var o=e.getBBox();n=o.width,i=o.height}else console.log("error: getDimensions() "+t+" not found.");return{w:n,h:i}},t.prototype.clean=function(){this.unbindEvent(),this.svg&&this.svg.remove(),e.select(this.linkPathPane).select("svg").remove()},t.prototype.destroy=function(){this.unbindEvent(),this.svg&&this.svg.remove(),e.select(this.linkPathPane).select("svg").remove()},t}(),s=function(){function t(){}return t.getRepeatCount=function(t){var e=n.uniq(t);return t.length-e.length},t.removeSomeChar=function(t){return t.replace("+","").replace(";","").replace(",","")},t.getDimensions=function(t){var e=document.getElementById(t),n=0,i=0;if(e){var o=e.getBBox();n=o.width,i=o.height}else console.log("error: getDimensions() "+t+" not found.");return{w:n,h:i}},t}(),u=function(){function t(t,e,n,i,o,r,a,l,s,u){var h=this;void 0===s&&(s=[]),void 0===u&&(u=[]),this.sankeyOptions=t,this.svg=e,this.linkG=n,this.height=i,this.width=o,this.sankey=r,this.linkPathInstance=a,this.nodeTooltipEle=l,this.primaryNodes=s,this.primaryLinks=u,this.selectedNodes=[],this.selectedNodesD3Dom=[],this.linkPathInfo={levelSumCount:0,linkInfo:[]},this.compare=function(t,e){var n=t.dy,i=e.dy;return n<i?1:n>i?-1:0},this.columnMap=new Map,this.sankeyOptions.data.columns.forEach(function(t,e){h.columnMap.set(e,t.map(function(t){return t.id}))})}return t.prototype.addEventHandler=function(){this.addEventForNodes()},t.prototype.removeEventHandler=function(){this.selectedNodesD3Dom=[],this.svg&&this.svg.selectAll(".node").on("click",null),this.svg&&this.svg.selectAll(".node").on("mouseover",null),this.svg&&this.svg.selectAll(".node").on("mousemove",null),this.svg&&this.svg.selectAll(".node").on("mouseout",null),this.svg&&this.svg.selectAll(".sankeyLink").on("mouseover",null),this.svg&&this.svg.selectAll(".sankeyLink").on("mousemove",null),this.svg&&this.svg.selectAll(".sankeyLink").on("mouseout",null)},t.prototype.addEventForNodes=function(){var t=this,n=this;this.svg.selectAll(".node").on("mousedown",function(){var i=e.event,o=e.select(i.target).attr("id");if(t.sankeyOptions.sankeyConfig.hasCtrlFunc&&(i.ctrlKey||i.metaKey)){if(t.svg.selectAll(".sankeyLink").remove(),t.linkPathInfo.linkInfo=[],t.selectedNodes.length<1?(t.selectedNodes.push(o),t.selectedNodesD3Dom.push(e.select(i.target))):1===t.selectedNodes.length?(t.selectedNodes.push(o),t.selectedNodesD3Dom.push(e.select(i.target))):t.selectedNodes.length>1&&(t.selectedNodes.shift(),t.selectedNodesD3Dom[0].attr("class","node"),t.selectedNodesD3Dom.shift(),t.selectedNodes.push(o),t.selectedNodesD3Dom.push(e.select(i.target))),t.selectedNodes.length>=2){var r=t.primaryLinks.filter(function(t){return t.sourceChain.indexOf(n.selectedNodes[0])>-1&&t.sourceChain.indexOf(n.selectedNodes[1])>-1}),a=e.sum(r,function(t){return t.value}),l=[];r.forEach(function(t){t.inpatIds.forEach(function(t){l.push(t)})}),console.log(r,"links");var s=t.getNodeById(t.selectedNodes[0]),u=t.getNodeById(t.selectedNodes[1]),h=u.dy*a/u.value,c={sourceChain:[],linkGroupIndex:10,source:s,target:u,value:a,inpatIds:l,dy:h,sy:0,ty:0};t.linkG.selectAll(".sankeyLink").data([c]).enter().append("path").attr("class","sankeyLink").attr("sourceChain",function(t){return t.sourceChain[0]}).attr("d",t.sankey.link()).style("fill",function(t){return t.source.color}).attr("fill-opacity",function(t){return.6})}}else if(t.sankeyOptions.sankeyConfig.hasShiftFunc&&i.shiftKey){e.event.preventDefault(),t.selectedNodes=[],t.selectedNodesD3Dom.forEach(function(t){t.attr("class","node")}),t.selectedNodesD3Dom=[];var d=t.getNodeById(o);t.linkPathInfo.levelSumCount=t.columnMap.size;var f=void 0;if(0===t.linkPathInfo.linkInfo.length){t.svg.selectAll(".sankeyLink").remove(),(k=t.sankeyOptions.data.links.filter(function(t){return t.sourceChain[0].toString()===o})).sort(t.compare),t.linkG.selectAll(".sankeyLink").data(k).enter().append("path").attr("class","sankeyLink").attr("sourceChain",function(t){return t.sourceChain[0]}).attr("d",t.sankey.link()).style("fill",function(t){return t.source.color}).attr("fill-opacity",function(t){return.6}),f=0,t.linkPathInfo.linkInfo=[],t.linkPathInfo.linkInfo.push({direction:f,nodeId:d.id,nodeLabel:d.label,nextNodeLabel:"",color:d.color,levelIndex:t.getColIndexById(d.id),linkValue:"",linkRestValue:""}),t.redrawLinkPath(t.linkPathInfo)}else{var p=t.linkPathInfo.linkInfo[t.linkPathInfo.linkInfo.length-1];if(0===p.direction)if(t.getColIndexById(d.id)===p.levelIndex)f=p.direction,t.linkPathInfo.linkInfo=[],t.linkPathInfo.linkInfo.push({direction:f,nodeId:d.id,nodeLabel:d.label,nextNodeLabel:"",color:d.color,levelIndex:t.getColIndexById(d.id),linkValue:""});else{f=t.getColIndexById(d.id)>p.levelIndex?1:-1,(m=t.linkPathInfo.linkInfo.map(function(t){return t.nodeId})).push(d.id);var v=t.getLinkInfoByIdChain(m);p.linkValue=v.linkValue,p.direction=f,p.nextNodeLabel=d.label,t.linkPathInfo.linkInfo.push({direction:f,nodeId:d.id,nodeLabel:d.label,nextNodeLabel:"",color:d.color,levelIndex:t.getColIndexById(d.id),linkValue:""})}else if(t.getColIndexById(d.id)===p.levelIndex){f=p.direction,t.linkPathInfo.linkInfo.pop();var g=t.linkPathInfo.linkInfo[t.linkPathInfo.linkInfo.length-1];(m=t.linkPathInfo.linkInfo.map(function(t){return t.nodeId})).push(d.id);v=t.getLinkInfoByIdChain(m);g.linkValue=v.linkValue,g.nextNodeLabel=d.label,t.linkPathInfo.linkInfo.push({direction:f,nodeId:d.id,nodeLabel:d.label,nextNodeLabel:"",color:d.color,levelIndex:t.getColIndexById(d.id),linkValue:""})}else if(!(p.direction>0&&t.getColIndexById(d.id)>p.levelIndex)&&(p.direction>0||t.getColIndexById(d.id)>p.levelIndex))f=0,t.linkPathInfo.linkInfo=[],t.linkPathInfo.linkInfo.push({direction:f,nodeId:d.id,nodeLabel:d.label,nextNodeLabel:"",color:d.color,levelIndex:t.getColIndexById(d.id),linkValue:""});else{var m;f=p.direction,(m=t.linkPathInfo.linkInfo.map(function(t){return t.nodeId})).push(d.id);v=t.getLinkInfoByIdChain(m);p.linkValue=v.linkValue,p.nextNodeLabel=d.label,t.linkPathInfo.linkInfo.push({direction:f,nodeId:d.id,nodeLabel:d.label,nextNodeLabel:"",color:d.color,levelIndex:t.getColIndexById(d.id),linkValue:""})}}t.redrawLinkPath(t.linkPathInfo)}else{var k;t.svg.selectAll(".sankeyLink").remove(),t.linkPathInfo.linkInfo=[],t.selectedNodes=[],t.selectedNodesD3Dom.forEach(function(t){t.attr("class","node")}),t.selectedNodesD3Dom=[],(k=t.sankeyOptions.data.links.filter(function(t){return t.sourceChain[0].toString()===o})).sort(t.compare),t.linkG.selectAll(".sankeyLink").data(k).enter().append("path").attr("class","sankeyLink").attr("sourceChain",function(t){return t.sourceChain[0]}).attr("d",t.sankey.link()).style("fill",function(t){return t.source.color}).attr("fill-opacity",function(t){return.6})}t.selectedNodesD3Dom.forEach(function(t){t.attr("class","node ctrl-selected")}),t.addEventForLinks()}),this.svg.selectAll(".node").on("mouseover",function(n){e.select(e.event.target).attr("fill-opacity",.8);var i=t.primaryNodes.filter(function(t){return t.id===n.id})[0].value;t.showTooltip(n.id,i,n,t.primaryNodes)}),this.svg.selectAll(".node").on("mousemove",function(n){var i=e.mouse(t.svg.node()),o=i[0]+20,r=i[1]+20,a=Number(window.getComputedStyle(t.nodeTooltipEle).width.replace("px","")),l=Number(window.getComputedStyle(t.nodeTooltipEle).height.replace("px",""));o+a>t.width&&(o=i[0]-20-a),r+l>t.height&&(r-=i[1]+l-t.height),t.moveTooltip(o,r)}),this.svg.selectAll(".node").on("mouseout",function(n){e.select(e.event.target).attr("fill-opacity",1),t.hiddenTooltip()})},t.prototype.addEventForLinks=function(){var t=this;this.svg.selectAll(".sankeyLink").on("mouseover",function(n){var i=e.select(e.event.target);i.attr("fill-opacity",.8);var o=t.sankeyOptions.data.links.filter(function(t){return t.source.id===n.source.id&&t.sourceChain[0]===n.sourceChain[0]&&n.linkGroupIndex===t.linkGroupIndex}),r=[];o.forEach(function(t){t.inpatIds.forEach(function(t){r.push(t)})});var a=s.getRepeatCount(r),l=e.sum(o,function(t){return t.value})-a,u=t.primaryNodes.filter(function(t){return t.id===n.source.id})[0].value,h=n.value-s.getRepeatCount(n.inpatIds),c=2!==t.selectedNodes.length?l:u;e.selectAll("#sankeyTipText").append("tspan").attr("x",0).attr("y",0).attr("dy","1.7em").text(n.source.label+" --\x3e "+n.target.label),e.selectAll("#sankeyTipText").append("tspan").attr("x",0).attr("y",20).attr("dy","1.7em").text(h+"人 ("+Math.round(1e4*h/c)/100+"%)"),e.selectAll("#sankeyTipText tspan").attr("x",5);var d=s.getDimensions("sankeyTipText"),f=d.w+10,p=d.h+20;e.select("#sankeyTipRect").attr("width",f).attr("height",p),e.select(".sankeyTooltip").transition().duration(120).style("opacity",1),i.on("mousemove",function(n){var i=e.mouse(t.svg.node()),o=i[0]+10,r=i[1]+10,a=Number(e.select("#sankeyTipRect").attr("width")),l=Number(e.select("#sankeyTipRect").attr("height"));o+a>t.width&&(o=i[0]-10-a),r+l>t.height&&(r=i[1]-10-(r+l-t.height)),e.selectAll(".sankeyTooltip").attr("transform",function(t){return"translate("+o+","+r+")"})})}),this.svg.selectAll(".sankeyLink").on("mouseout",function(t){var n=e.select(e.event.target);n.attr("fill-opacity",.6),n.on("mousemove",null),e.select(".sankeyTooltip").style("opacity",0).attr("transform",function(t,e){return"translate(-500,-500)"}),e.selectAll("#sankeyTipText tspan").remove()})},t.prototype.redrawLinkPath=function(t){this.linkPathInstance.draw(t)},t.prototype.getLinkInfoByIdChain=function(t){var e=this.getLinkValueByIdChain(t),i=t.filter(function(e,n){return n<t.length-1}),o=this.getLinkValueByIdChain(i),r=e.linkValue-s.getRepeatCount(e.allIds),a=o.linkValue-s.getRepeatCount(o.allIds);return{linkValue:r+"人（"+(0===a?0:n.round(100*r/a,2))+"%）"}},t.prototype.getLinkValueByIdChain=function(t){var n=this.primaryLinks.filter(function(e){for(var n=!0,i=0;i<t.length;i++)if(-1===e.sourceChain.indexOf(t[i])){n=!1;break}return n}),i=e.sum(n,function(t){return t.value}),o=[];return n.forEach(function(t){t.inpatIds.forEach(function(t){o.push(t)})}),{linkValue:i=i,allIds:o}},t.prototype.showTooltip=function(t,e,i,o){if(n.isFunction(this.sankeyOptions.nodeTooltipFormatter)){for(this.nodeTooltipEle.style.setProperty("display","block");this.nodeTooltipEle.firstChild;)this.nodeTooltipEle.removeChild(this.nodeTooltipEle.firstChild);this.nodeTooltipEle.innerHTML=this.sankeyOptions.nodeTooltipFormatter(t,e,i,o)}else{var r=[];r.push(i.label+": "+o.filter(function(e){return e.id===t})[0].value+"人"),i.tips.forEach(function(t){r.push(t)});var a=document.createElement("ul");for(a.setAttribute("class","sankeyTooptipUl"),a.setAttribute("style","\n            padding: 0;\n            margin: 0;\n            list-style: none;\n            position: relative;\n            "),r.forEach(function(t){var e=document.createElement("li");e.setAttribute("class","sankeyTooptipLi"),e.setAttribute("style","\n                    display: block;\n                    overflow: hidden;\n                    line-height: 20px;\n                    font-size: 12px;\n                    color: white;\n                    font-family: PingFangSC;\n                ");var n=document.createElement("div");n.setAttribute("class","sankeyTooptipLiLeftDiv"),n.setAttribute("style","\n                float: left;\n                ");var i=document.createElement("div");i.setAttribute("class","sankeyTooptipLiRightDiv"),i.setAttribute("style","\n                text-align: end;\n                float: right;\n                "),n.innerHTML=t.split(":")[0]+":&nbsp;",i.innerHTML=t.split(":")[1],e.appendChild(n),e.appendChild(i),a.appendChild(e)}),this.nodeTooltipEle.style.setProperty("display","block");this.nodeTooltipEle.firstChild;)this.nodeTooltipEle.removeChild(this.nodeTooltipEle.firstChild);this.nodeTooltipEle.appendChild(a)}},t.prototype.moveTooltip=function(t,e){this.nodeTooltipEle.style.setProperty("top",e+"px"),this.nodeTooltipEle.style.setProperty("left",t+"px")},t.prototype.hiddenTooltip=function(){for(;this.nodeTooltipEle.firstChild;)this.nodeTooltipEle.removeChild(this.nodeTooltipEle.firstChild);this.nodeTooltipEle.style.setProperty("display","none")},t.prototype.getNodeById=function(t){for(var e,n=0;n<this.sankeyOptions.data.columns.length;n++){var i;if((i=this.sankeyOptions.data.columns[n].filter(function(e){return e.id===t})).length>0){e=i[0];break}}return e},t.prototype.getColIndexById=function(t){var e=-1;return this.columnMap.forEach(function(n,i){n.indexOf(t)>-1&&(e=i)}),e},t}(),h=function(){function t(t){this.div=t,this.count=0}return t.prototype.getDemoData=function(){var t={columns:[[{id:"a",label:"a",value:100,tips:["a:100"],color:""},{id:"2a",label:"2a",value:100,tips:["2a:100"],color:""},{id:"3a",label:"3a",value:100,tips:["3a:100"],color:""}],[{id:"b",label:"b",value:100,tips:["b:100"],color:""},{id:"2b",label:"2b",value:100,tips:["2b:100"],color:""},{id:"3b",label:"3b",value:100,tips:["3b:100"],color:""},{id:"4b",label:"3b",value:100,tips:["4b:100"],color:""}],[{id:"c",label:"c",value:100,tips:["c:100"],color:""},{id:"2c",label:"2c",value:100,tips:["2c:100"],color:""},{id:"3c",label:"3c",value:100,tips:["3c:100"],color:""},{id:"4c",label:"4c",value:100,tips:["4c:100"],color:""},{id:"5c",label:"5c",value:100,tips:["5c:100"],color:""}],[{id:"d",label:"d",value:100,tips:["d:100"],color:""},{id:"2d",label:"2d",value:100,tips:["2d:100"],color:""},{id:"3d",label:"3d",value:100,tips:["3d:100"],color:""}],[{id:"e",label:"e",value:100,tips:["e:100"],color:""},{id:"2e",label:"2e",value:100,tips:["2e:100"],color:""}]],links:[]};return t.links=this.getLinks(t.columns),t},t.prototype.getLinks=function(t){var e=[];return this.go(t,e,0),console.log("count",this.count),console.log("links",e),e},t.prototype.go=function(t,e,n,i){void 0===i&&(i=null);for(var o=0;o<=t[n].length-1;o++){var r=null;if(r={sourceChain:[],source:"",target:"",value:0,inpatIds:[]},i)for(r=JSON.parse(JSON.stringify(i));r.sourceChain.length>n;)r.sourceChain.pop();r.sourceChain.push(t[n][o].id),n===t.length-1?(r.source=r.sourceChain[r.sourceChain.length-2],r.target=r.sourceChain[r.sourceChain.length-1],r.value=10,e.push(JSON.parse(JSON.stringify(r))),console.log("row: "+o,"column: "+n),console.log("link: ",r.sourceChain),r=null,r={sourceChain:[],source:"",target:"",value:0,inpatIds:[]},this.count++):this.go(t,e,n+1,r)}},t.prototype.showDemoSankey=function(){var t=this.getDemoData(),e={parentEle:this.div,data:t,sankeyConfig:{nodeWidth:20,nodePadding:20,curvature:.2,hasShiftFunc:!0,hasCtrlFunc:!0}};i.initSankey(e).draw()},t}(),c=function(){function t(t){this.options=t,this.margin={top:10,right:10,bottom:10,left:10},this.primaryLinks=[],this.primaryNodes=[],this._config={nodeWidth:20,nodePadding:20,curvature:.2,hasShiftFunc:!0,hasCtrlFunc:!0},this.data=t.data,this.parentEle=t.parentEle,Object.assign(this._config,t.sankeyConfig),this.initData()}return t.prototype.initData=function(){var t=this;this.data.links.forEach(function(e){t.primaryLinks.push(n.clone(e))}),this.data.columns.forEach(function(e){e.forEach(function(e){t.primaryNodes.push(n.clone(e))})});var e=new a(this.data);e.parseData(),this.data=e.data},t.prototype.initLinkPath=function(){this.linkPathInstance=new l(this.linkPathEle),this.linkPathInstance.clearLinkPathInfo()},t.prototype.createLinkPathEle=function(){this.linkPathEle=document.createElement("div"),this.linkPathEle.setAttribute("class","link-path"),this.parentEle.appendChild(this.linkPathEle)},t.prototype.createMainDiagramEle=function(){var t="";t=this.options.sankeyConfig.hasShiftFunc?"sankey-diagram":"sankey-diagram-without-shiftfunc",this.mainDiagramEle=document.createElement("div"),this.mainDiagramEle.setAttribute("class",t),this.parentEle.appendChild(this.mainDiagramEle)},t.prototype.createNodeTooltipEle=function(){this.nodeTooltipEle=document.createElement("div"),this.nodeTooltipEle.setAttribute("class","sankey-node-tooltip"),this.mainDiagramEle.appendChild(this.nodeTooltipEle)},t.prototype.draw=function(){this.createContainerDom(),this.options.sankeyConfig.hasShiftFunc&&this.initLinkPath(),this.clean(),this.getSize(),this.drawSvg(),this.drawSankey(),this.drawTooltipForLinks(),this.addEventHandler()},t.prototype.resize=function(){this.draw()},t.prototype.createContainerDom=function(){e.select(this.parentEle).selectAll("div").remove(),this.options.sankeyConfig.hasShiftFunc&&this.createLinkPathEle(),this.createMainDiagramEle(),this.createNodeTooltipEle()},t.prototype.getSize=function(){var t=this.mainDiagramEle.getClientRects();t&&t[0]&&(this.width=t[0].width-this.margin.left-this.margin.right,this.height=t[0].height-this.margin.top-this.margin.bottom)},t.prototype.drawSvg=function(){this.svg=e.select(this.mainDiagramEle).append("svg").attr("width",this.width+this.margin.left+this.margin.right).attr("height",this.height+this.margin.top+this.margin.bottom).append("g").attr("transform","translate("+this.margin.left+","+this.margin.top+")")},t.prototype.drawSankey=function(){var t=this;this.sankey=new r,this.sankey.nodeWidth(this._config.nodeWidth).nodePadding(this._config.nodePadding).curvature(this._config.curvature).size([this.width,this.height]);this.sankey.link();this.sankey.columns(this.data.columns).links(this.data.links).layout(32);this.svg.append("defs").append("svg:clipPath").attr("id","clip").append("svg:rect").attr("id","clip-rect").attr("width",this.width).attr("height",this.height-2).attr("fill","#fff").attr("transform","translate(0,1)");this.linkG=this.svg.append("g").attr("clip-path","url(#clip)");var e=this.svg.append("g").selectAll(".nodeG").data(this.sankey.getNodes()).enter().append("g").attr("class","nodeG").attr("transform",function(t){return"translate("+t.x+","+t.y+")"});e.append("rect").attr("clip-path","url(#clip-rect)").attr("class","node").attr("id",function(t){return t.id}).attr("height",function(t){return t.dy}).attr("width",this.sankey.getNodeWidth()).style("fill",function(t){return t.color}).style("cursor","pointer"),e.append("text").filter(function(t){return t.value>0}).attr("x",-6).attr("y",function(t){return t.dy/2}).attr("dy",".35em").attr("text-anchor","end").attr("transform",null).attr("font-size","12").attr("color","#0C2237").text(function(t){return t.label}).filter(function(e){return e.x<t.width/2}).attr("x",6+this.sankey.getNodeWidth()).attr("text-anchor","start")},t.prototype.drawTooltipForLinks=function(){var t=this.svg.append("g").attr("font-family","PingFangSC").attr("font-size",12).attr("text-anchor","start").attr("class","sankeyTooltip").attr("opacity","0").attr("transform","translate(-500,-500)");t.append("rect").attr("id","sankeyTipRect").attr("x",0).attr("width",120).attr("height",80).attr("rx",5).attr("ry",5).attr("opacity",.9).style("fill","#000"),t.append("text").attr("id","sankeyTipText").attr("x",0).attr("y",0).attr("fill","#fff").style("font-size",12).style("line-height",12).style("font-family","PingFangSC").text(function(t,e){return""})},t.prototype.addEventHandler=function(){this.eventHandler=new u(this.options,this.svg,this.linkG,this.height,this.width,this.sankey,this.linkPathInstance,this.nodeTooltipEle,this.primaryNodes,this.primaryLinks),this.eventHandler.addEventHandler()},t.prototype.removeEventHandler=function(){this.eventHandler.removeEventHandler()},t.prototype.clean=function(){this.eventHandler&&this.removeEventHandler(),this.svg&&this.svg.remove(),e.select(this.mainDiagramEle).select("svg").remove()},t.prototype.destroy=function(){this.eventHandler&&this.removeEventHandler(),this.svg&&this.svg.remove(),e.select(this.mainDiagramEle).select("svg").remove(),this.sankey,this.mainDiagramEle=null,this.data=null},t}();t.initSankey=function(t){return new c(t)},t.showDemoSankey=function(t){new h(t).showDemoSankey()},Object.defineProperty(t,"__esModule",{value:!0})});
